global
#    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 30000
    nbproc 1
    nbthread 4
    cpu-map auto:1/1-4 0-3

   # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Default ciphers to use on SSL-enabled listening sockets.
    # For more information, see ciphers(1SSL). This list is from:
    #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
    #ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
    #ssl-default-bind-options no-sslv3
#    tune.ssl.default-dh-param 1024
#    ssl-default-bind-options no-sslv3
#    ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS

#    ssl-default-server-options no-sslv3
#    ssl-default-server-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS

#To support old Java 6 clients

   tune.ssl.default-dh-param 2048
    # tune.ssl.default-dh-param 1024
    ssl-default-bind-ciphers ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
    ssl-default-bind-options no-sslv3 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
    ssl-default-server-options no-sslv3 no-tls-tickets

defaults
    log    global
    mode    http
    option    httplog
#    option dontlog-normal
    option    dontlognull
    option  forwardfor
    #option http-keep-alive
    option    http-server-close
    option    redispatch
    option  tcp-smart-accept
    option    tcp-smart-connect
    timeout connect 5000
    timeout client  30000
    timeout server  1200000
    timeout http-keep-alive 500
    compression algo gzip
    compression type text/html text/html;charset=utf-8 text/plain text/css text/javascript application/x-javascript application/javascript application/ecmascript application/rss+xml application/atomsvc+xml application/atom+xml application/atom+xml;type=entry application/atom+xml;type=feed application/cmisquery+xml application/cmisallowableactions+xml application/cmisatom+xml application/cmistree+xml application/cmisacl+xml application/msword application/vnd.ms-excel application/vnd.ms-powerpoint
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

frontend stats
    log /dev/log  local0 warning

    bind *:8990 ssl crt /etc/haproxy/ssl/acceptanstest.eclub.se.pem alpn h2,http/1.1
    mode http
    stats enable
    stats uri /
    stats realm HAProxy\ Statistics
    stats auth adminuser:@@.Cisco123@@
    stats admin if TRUE

    default_backend stats_back

frontend f_web
#    log /dev/log  local0 notice
    log /dev/log  local1 notice
    bind *:80
    maxconn 10000
    #tenant
    #acl network_allowed src 212.247.219.242 62.63.251.163
    #acl restricted_page path_beg -i /tenants
    #http-request deny if restricted_page !network_allowed

    ## deny partnerportal for all but whitelisted ip:s
    # load whitelist from file
    acl partner_whitelist src -f /etc/haproxy/partner_whitelist.acl
    acl is_partner hdr_sub(host) -i -m beg partners.
    acl is_partner path -i -m beg /partners
    acl is_partner path -i -m beg /data/partners
    http-request deny if is_partner !partner_whitelist
    # end partnerportal ip

    acl is_beta hdr_sub(cookie) usebeta=true


    #Check host
    acl host_is_partners hdr_sub(host) -m beg partners.
    acl host_is_instore hdr_sub(host) -i .instore.
    acl has_partners_in_path path_beg /partners/
    acl has_datapartners_in_path path_beg /data/partners/
    acl host_acceptanstest hdr_sub(host) -i acceptanstest.eclub.se
    acl host_acceptanstest hdr_sub(host) -i acceptanstest.voyado.com
    acl host_accpetanstest hdr_sub(host) -i -f /etc/haproxy/acceptanstest.suburl.cfg
    acl host_dormy hdr_sub(host) -i medlem.dormy.com
    acl host_kjell_s hdr_sub(host) -i s-medlem.kjell.com
    acl host_kjell_s_tiny hdr_sub(host) -i s-t.kjell.com
    acl host_flinks_m hdr_sub(host) -i m.flinks.se
    acl host_kjell hdr_sub(host) -i medlem.kjell.com
    acl host_medlmio hdr_sub(host) -i medl.mio.se
    acl host_kjell_tiny hdr_sub(host) -i t.kjell.com
    acl path_is_brothersform path_beg -i /open/registration/register/fd3eea1f-0a7b-4f0c-bc74-a7740086870a
    acl is_root path -i /
    acl path_is_csrreq path_beg -i /.well-known/pki-validation
    acl path_is_loaderio_verification path_beg -i /loaderio-
    acl path_is_symantec_verification path_beg -i /nortonsw
    acl path_is_opencontact path_beg -i /open/contact/

    acl letsencrypt-acl path_beg /.well-known/acme-challenge/

    acl is_old_public hdr_reg(Host) -i ^web\..+(voyado\.com|eclub\.se)
    acl is_new_public hdr_reg(Host) -i \.customer\.

    #Throttling
    acl api_request path_beg -i /api
    acl path_is_linkclick path_beg -i /link/
    acl has_apikey req.hdr(apikey,1) -m len gt 0
    acl too_many_apirequests_by_user sc0_gpc0_rate() gt 200
    acl mark_seen sc0_inc_gpc0 gt 0
    stick-table type string size 100k store gpc0_rate(1s)
    tcp-request content track-sc0 hdr(apikey) if api_request has_apikey

    #Fallback
    # acl not_enough_servers nbsrv(bk_production_without_sticky) lt 1

    acl should_log path_beg -i /api/v2/contactoverview
    http-request set-log-level silent unless should_log

            unique-id-format  %{+X}o\ %pid%ci%cp%fi%fp%Ts%ms%rt
        acl cid_exists req.hdr(X-Correlation-ID) -m found
        http-request set-header X-Correlation-ID %[unique-id] unless cid_exists
        http-request capture hdr(X-Correlation-ID) len 64
        http-request capture req.hdr(Host) len 50

    log-format {\"id\":\"%[capture.req.hdr(0),json(utf8)]\",\"httphost\":\"%[capture.req.hdr(1),json(utf8)]\",\"host\":\"%H\",\"HU\":\"%HU\",\"ST\":\"%ST\",\"T\":\"%T\",\"Ta\":%Ta,\"Tc\":%Tc,\"Td\":%Td,\"Th\":%Th,\"Ti\":%Ti,\"Tq\":%Tq,\"TR\":%TR,\"Tr\":%Tr,\"Tt\":%Tt,\"ac\":%ac,\"bc\":%bc,\"bq\":%bq,\"fc\":%fc,\"rc\":%rc,\"s\":\"%s\",\"sc\":%sc,\"sq\":%sq,\"t\":\"%t\",\"trg\":\"%trg\",\"ts\":\"%ts\"}

    http-request set-header Host %[hdr(host),map(/etc/haproxy/customstagingdomains.map)] if { hdr(host),map(/etc/haproxy/customstagingdomains.map) -i -m found }

    http-request redirect prefix https://%[req.hdr(Host),lower,field(1,:),regsub(^web\.,),regsub(\.acceptanstest\.eclub\.se$,.customer.acceptanstest.eclub.se),regsub(\.acceptanstest\.voyado\.com$,.customer.acceptanstest.voyado.com)] code 302 if is_old_public host_acceptanstest
    # http-request redirect prefix https://%[req.hdr(Host),lower,field(1,:),regsub(^web\.,),regsub(\.eclub\.se$,.customer.eclub.se),regsub(\.voyado\.com$,.customer.voyado.com)] code 302 if is_old_public !host_acceptanstest !host_staging
#     http-request redirect prefix https://%[req.hdr(Host),lower,field(1,:)] code 302 if is_new_public !host_acceptanstest

#    http-request redirect prefix https://t.customer.power.no code 302 if hdr_sub(host) -i tinyurl.powerno.voyado.com

    http-request set-header Host %[req.hdr(Host),regsub(\.customer,)] if is_new_public host_acceptanstest
    # http-request set-header Host %[req.hdr(Host),regsub(\.customer,)] if is_new_public host_staging
#     http-request set-header Host %[req.hdr(Host),regsub(\.customer,)] if is_new_public !host_acceptanstest !host_staging

    http-request replace-value Host medlem\.dormy\.com dormy.customer.voyado.com
    http-request replace-value Host waynescoffee\.customer\.eclub\.se web.waynescoffee.eclub.se
    http-request replace-value Host mekonomen\.customer\.eclub\.se mekonomen.eclub.se
    http-request replace-value Host rusta\.customer\.eclub\.se rusta.eclub.se
    http-request replace-value Host rustano\.customer\.eclub\.se rustano.eclub.se
    http-request replace-value Host rustade\.customer\.eclub\.se rustade.eclub.se
    http-request set-header Host httpcsrdsv.azurewebsites.net if path_is_csrreq

    #hotfix consent
    http-request set-path %[path,regsub(ou2qrl_hcE5bj4-GbOxg7QMBumcPBxBtU3AIGmrCPxdT8mTEizBFyJ1HoT83TRDOkgNI-y52ai_K1PZb8IW6syOWYi2kTBD2ZowZpX_vOucSgATQ,XGj9McUMZfAITXc06OA9Xg1PwsJ8nW4b4TifNnVYseY1J8pbcxatCz9U83KCTAdEI4nVnCS_G7xqQ_frP2Zbs2S-vwuPhzALQ8Y9j85xcjgxwqmxmCZ8g,)] if { hdr(host) -i web.swedol.eclub.se } path_is_opencontact
    http-request set-path %[path,regsub(ou2qrl_hcE5bj4-GbOxg7QMBumcPBxBtU3AIGmrCPxdT8mTEizBFyJ1HoT82bCFf9nOoHRxXG_-qwDfad-bqk6ciCHr4CTS2t1wc4Q4uGkwK1MXuCDHD8p3Ak,lvD9iUdXAe-aUXOX6TQzKgwAaB-nxc8PDYBJqEVmoyRaGD4Y6WvyIAxkCJnKTVPQ1DP3LoeMpVYdWXFSv3Dr5Orh9SiMHlgC36U23pUDnCg4aDwYcPOrVdGl1GGHsP,)] if { hdr(host) -i web.swedol.eclub.se } path_is_opencontact

    http-request set-path %[path,regsub(GSWeFR6yQDEuJRM8XUF2aQnrvB06T92X7I0BLbnxD0C2vEYPvi2Vzlf3zI6jhLGs0eVCnMmy2o4W7JzEI0e1L1Vbzl5HO1lj_Q_MF5HFf9IeyGXRLoJdG8ww,kVd5tV3epYl74xMKWHVyGA1GhxOLrUNh2wpfOcSFQlps3l2PK7MQ1q2AAqCANeEyOrCyMafGOFq4f1MLHtKK8cKQHh_I797u5tfWHkb28E95gHjbKPFsVlVL85,)] if { hdr(host) -i web.trmedia.eclub.se } path_is_opencontact
    http-request set-path %[path,regsub(GSWeFR6yQDEuJRM8XUF2aQnrvB06T92X7I0BLbnxD0C2vEYPvi2Vzlf3zI6ipYA9tZWievuTq152-F1FpCTlD9HvpAkbfn0jLN_JU-AEX3kGnKTg,PQu74HgILEAlAMvlMooEPQ3nwGT5VDi98K0SHuIH2DOQavyWKEIyGM_AFP1DDVE5x3D_NZOpFC9tbv569igdnQUV5V3rL3d1g-sXrYR1E8qF2DJcA,)] if { hdr(host) -i web.trmedia.eclub.se } path_is_opencontact
    http-request set-path %[path,regsub(GSWeFR6yQDEuJRM8XUF2aQnrvB06T92X7I0BLbnxD0C2vEYPvi2Vzlf3zI6jhLGs0eVCnMmy2o4W7JzEI0e1L1Vbzl5HO1lj_Q_MF5HFf9IeyGXRLiJJW_nJA,fU3i4cFjCXwlK0oLEyJL9w4vQTuqAq0n6fstwFKBdz0nZRUj8Arp2DdMy-j2w77MWSGYmXEjL9c9YpicwixBaIfdiGM8Z56onghHNBfZv-63L3Yw4aLqoJafVC,)] if { hdr(host) -i web.trmedia.eclub.se } path_is_opencontact

    redirect scheme https if !{ ssl_fc } host_is_partners
    redirect scheme https if !{ ssl_fc } has_partners_in_path
    redirect scheme https if !{ ssl_fc } has_datapartners_in_path
    redirect scheme https if !{ ssl_fc } host_is_instore
    #redirect scheme https if !{ ssl_fc } is_new_public !host_acceptanstest !host_staging

    redirect location http://web.brothersfi.eclub.se/open/registration/register/10bbcd1b-93ed-4759-b83e-a7d800cc4140 if path_is_brothersform
    redirect location https://kjell.com/medlem if host_kjell is_root
    redirect location https://medlem.mio.se if host_medlmio is_root

        #hotfix elon
        redirect location http://www.elon.se code 302 if { path_beg /link/zKkPJZCyfk6d-qhNAI5Mdg }

    #hotfix revide utskick
    redirect location http://www.revide.se/sv/kontakt code 302 if { path_beg /link/BYt_JXVzNkyN5alRAOj9Wg }
    redirect location http://www.revide.se/sv/kontakt code 302 if { path_beg /link/vvYWvgHpokCprqlRAOj9Wg }

    redirect prefix https://demo.instore.eclub.se code 301 if { hdr(host) -i instore.demo.eclub.se }
    redirect prefix https://swedol.instore.eclub.se code 301 if { hdr(host) -i instore.swedol.eclub.se }
    redirect prefix https://swedolnorge.instore.eclub.se code 301 if { hdr(host) -i instore.swedolnorge.eclub.se }
    redirect prefix https://parfymeri-l.instore.eclub.se code 301 if { hdr(host) -i instore.parfymeri-l.eclub.se }
    redirect prefix https://bjornborg.instore.eclub.se code 301 if { hdr(host) -i instore.bjornborg.eclub.se }
    redirect prefix https://stroms.instore.eclub.se code 301 if { hdr(host) -i instore.stroms.eclub.se }
    redirect prefix https://andyslekland.instore.eclub.se code 301 if { hdr(host) -i instore.andyslekland.eclub.se }
    redirect prefix https://happyhomes.instore.eclub.se code 301 if { hdr(host) -i instore.happyhomes.eclub.se }
    redirect prefix https://uropenn.instore.eclub.se code 301 if { hdr(host) -i instore.uropenn.eclub.se }
    redirect prefix https://mekonomen.customer.eclub.se code 301 if { hdr(host) -i web.mekonomen.eclub.se }
    redirect prefix https://rusta.customer.eclub.se code 301 if { hdr(host) -i web.rusta.eclub.se }
    redirect prefix https://rustano.customer.eclub.se code 301 if { hdr(host) -i web.rustano.eclub.se }
    redirect prefix https://rustade.customer.eclub.se code 301 if { hdr(host) -i web.rustade.eclub.se }

    # Check what backend to handle the request

    use_backend letsencrypt-backend if letsencrypt-acl
    use_backend bk_429_slow_down if api_request has_apikey mark_seen too_many_apirequests_by_user
    use_backend bk_csrdsv if path_is_csrreq
    use_backend bk_csrdsv if path_is_loaderio_verification
    use_backend bk_csrdsv if path_is_symantec_verification

    use_backend bk_acceptanstest if host_acceptanstest
    #use_backend bk_production_beta if host_production is_beta
    #Fallback

#     use_backend bk_production_api if host_production api_request
#     use_backend bk_production_public if host_production path_is_linkclick

#     use_backend bk_production_api if host_kjell api_request
#     use_backend bk_production_public if host_kjell path_is_linkclick

#     use_backend bk_production_backup if not_enough_servers

#     use_backend bk_production if host_production
#     use_backend bk_staging if host_kjell_s
#     use_backend bk_staging if host_kjell_s_tiny
#     use_backend bk_production if host_flinks_m
#     use_backend bk_production if host_kjell
#     use_backend bk_production if host_dormy
#     use_backend bk_production if host_kjell_tiny

frontend f_web-https-acceptanstest
        log /dev/log  local0 warning
        bind *:443 ssl crt /etc/haproxy/ssl/acceptanstest.eclub.se.pem alpn h2,http/1.1 prefer-client-ciphers no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:!aNULL:!MD5:!DSS
#	log /dev/log local debug
        default_backend bk_acceptanstest
        tcp-request inspect-delay 5s
        mode http
        maxconn 10000

        #tenant
        #acl network_allowed src 212.247.219.242 62.63.251.163
        #acl restricted_page path_beg -i /tenants
        #http-request deny if restricted_page !network_allowed

        ## deny partnerportal for all but whitelisted ip:s
        # load whitelist from file
        acl partner_whitelist src -f /etc/haproxy/partner_whitelist.acl
        acl is_partner hdr_sub(host) -i -m beg partners.
        acl is_partner path -i -m beg /partners
        acl is_partner path -i -m beg /data/partners
        http-request deny if is_partner !partner_whitelist
        # end partnerportal ip

        http-request del-header ^X-Forwarded-For:.*
        http-request set-header X-ARR-SSL true
        http-request set-header X-SSL-CIPHERS %[ssl_fc_cipher]
        http-request set-header X-SSL-PROTOCOL %[ssl_fc_protocol]

        #Check host
        acl host_beg_managedash hdr_sub(host) -m beg manage-
        acl host_is_partners hdr_sub(host) -m beg partners.
        acl has_partners_in_path path_beg /data/partners/
        acl has_partners_in_path2 path_beg /LoginRouter/
        acl is_old_public hdr_reg(Host) -i ^web\..+(voyado\.com|eclub\.se)
        acl is_new_public hdr_reg(Host) -i \.customer\.

        ## Linkjump i frontend www-https
        acl is_link_path path_reg ^/(open/link/jump|link)/([^/]+/){5}[^/]{22}$
        acl is_az_link_enabled req.hdr(host),lower,map(/etc/haproxy/use-az-fn-link-jump.atst.map) -m found

        #Throttling
        acl api_request path_beg -i /api
        acl has_apikey req.hdr(apikey,1) -m len gt 0
        acl too_many_apirequests_by_user sc0_gpc0_rate() gt 200
        acl mark_seen sc0_inc_gpc0 gt 0
        stick-table type string size 100k store gpc0_rate(1s)
        tcp-request content track-sc0 hdr(apikey) if api_request has_apikey

        http-request redirect prefix https://%[req.hdr(Host),lower,field(1,:),regsub(^web\.,),regsub(\.acceptanstest\.eclub\.se$,.customer.acceptanstest.eclub.se),regsub(\.acceptanstest\.voyado\.com$,.customer.acceptanstest.voyado.com)] code 302 if is_old_public
        http-request set-header Host %[req.hdr(Host),regsub(\.customer,)] if is_new_public

        http-request set-path /partners/%[path] if !has_partners_in_path2 !has_partners_in_path host_is_partners
        http-request replace-value Host partners\.(.*) \1
        http-request replace-value Host manage\-(.*) \1
        http-request set-header X-Forwarded-Proto https
        # Check what backend to handle the request
        use_backend bk_429_slow_down if api_request has_apikey mark_seen too_many_apirequests_by_user
        use_backend link_servers_atst if is_link_path is_az_link_enabled

# frontend f_web-https
#         log /dev/log  local0 info
#         bind 52.164.245.10:443 ssl crt /etc/haproxy/ssl/2021voyado.com.pem alpn h2,http/1.1
#         bind 52.164.245.10:20443 ssl crt /etc/haproxy/ssl/2021voyado.com.pem alpn h2,http/1.1
#         bind 127.0.0.1:20443 ssl crt /etc/haproxy/ssl/2021voyado.com.pem alpn h2,http/1.1
#         bind 13.69.189.81:443 ssl crt /etc/haproxy/ssl/2021voyado.com.pem alpn h2,http/1.1
#         bind 52.169.84.183:443 ssl crt /etc/haproxy/ssl/2021voyado.com.pem alpn h2,http/1.1
#         bind 52.178.134.200:443 ssl crt /etc/haproxy/ssl/medlem.eclub.se.pem alpn h2,http/1.1
#         mode http
#         maxconn 20000

#         #tenant
#         #acl network_allowed src 212.247.219.242 62.63.251.163
#         #acl restricted_page path_beg -i /tenants
#         #http-request deny if restricted_page !network_allowed

#         # Deny suspicious user agents
#         http-request deny if { req.hdr(user-agent) -i -m sub -f /etc/haproxy/badagents.acl }

#         ## deny partnerportal for all but whitelisted ip:s
#         # load whitelist from file
#         acl partner_whitelist src -f /etc/haproxy/partner_whitelist.acl
#         acl is_partner hdr_sub(host) -i -m beg partners.
#         acl is_partner path -i -m beg /partners
#         acl is_partner path -i -m beg /data/partners
#         http-request deny if is_partner !partner_whitelist
#         # end partnerportal ip

#         acl has_tenants_in_path path_beg -i /tenants

#         ## Linkjump i frontend www-https
#         acl is_link_path path_reg ^/(open/link/jump|link)/([^/]+/){5}[^/]{22}$
#         acl is_az_link_enabled req.hdr(host),lower,map(/etc/haproxy/use-az-fn-link-jump.prod.map) -m found
#         #acl is_linkjump is_link_path && is_az_link_enabled

#         ## Contactoverview
#         acl is_contactoverview path_beg /api/v2/contactoverview

#         reqidel ^X-Forwarded-For:.*
#         http-request set-header X-ARR-SSL true
#         http-request set-header X-Forwarded-Proto https
#         http-request set-header X-SSL-CIPHERS %[ssl_fc_cipher]
#         http-request set-header X-SSL-PROTOCOL %[ssl_fc_protocol]


#         acl is_beta hdr_sub(cookie) usebeta=true

#         #Check host
#         acl host_is_socialcallback hdr_sub(host) -i socialcallback.voyado.com
#         acl host_is_socialcallback_test hdr_sub(host) -i socialcallback-test.voyado.com

#         acl host_beg_managedash hdr_sub(host) -m beg manage-
#         acl host_is_partners hdr_sub(host) -m beg partners.
#         acl has_partners_in_path path_beg /data/partners/
#         acl has_partners_in_path2 path_beg /LoginRouter/

#         acl host_acceptanstest hdr_sub(host) -i -f /etc/haproxy/acceptanstest.suburl.cfg

#         # acl host_staging hdr_sub(host) -i -f /etc/haproxy/staging.suburl.cfg

#         # acl host_production hdr_sub(host) -i eclub.se
#         # acl host_production hdr_sub(host) -i voyado.com
#         # acl host_production hdr_sub(host) -i -f /etc/haproxy/production.suburl.cfg

#         acl host_kjell_s hdr_sub(host) -i s-medlem.kjell.com
#         acl host_landingpagesmio hdr_sub(host) -i landingpagesmio.eclub.se
#         acl host_landingpageshemglass hdr_sub(host) -i glasskompis.eclub.se
#         acl host_kjell_s_tiny hdr_sub(host) -i s-t.kjell.com

#         acl host_flinks_m hdr_sub(host) -i m.flinks.se

#         acl host_dormy hdr_sub(host) -i medlem.dormy.com

#         acl host_kjell hdr_sub(host) -i medlem.kjell.com
#         acl host_medlmio hdr_sub(host) -i medl.mio.se
#         acl host_kjell_tiny hdr_sub(host) -i t.kjell.com
#         acl is_root path -i /
#         acl is_jollyroom hdr_sub(host) -i jollyroom.eclub.se
#         acl is_api path_beg /api
#         acl is_old_public hdr_reg(Host) -i ^web\..+(voyado\.com|eclub\.se)
#         acl is_new_public hdr_reg(Host) -i \.customer\.
#         acl path_is_loaderio_verification path_beg -i /loaderio-
#         acl path_is_symantec_verification path_beg -i /nortonsw
#         acl path_is_open path_beg -i /open
#         acl path_is_linkclick path_beg -i /link/
#         acl path_is_googleverification path_beg -i /googlee8c9669fb3829e32.html
#         acl letsencrypt-acl path_beg /.well-known/acme-challenge/
#         acl xxl1 path_sub ku2q6v6cY0y0OaoCAT8yJg
#         acl xxl3 path_sub 5vl2Y4QYckWGJqoCAT8HgQ
#         acl xxl2 path_sub nii78pBWdE-M_aoCAT7T5A


#         acl host_xxlno hdr_sub(host) -i xxlno.customer.eclub.se

# #5vl2Y4QYckWGJqoCAT8HgQ

    #Throttling
#         acl api_request path_beg -i /api
#         acl has_apikey req.hdr(apikey,1) -m len gt 0
#         acl exceeds_limit_1s sc_http_req_rate(0) gt 200
#         acl exceeds_limit_60s sc_http_req_rate(1) gt 3000

#         http-request track-sc0 req.hdr(apikey) table be_table_ratelimit_1s if api_request has_apikey
#         http-request track-sc1 req.hdr(apikey) table be_table_ratelimit_60s if api_request has_apikey

#         acl should_log path_beg -i /api/v2/contactoverview
#         #acl should_log path_beg -i /api req.hdr(apikey,1) -m len gt 0 sc_http_req_rate(0) gt 200

#         #Fallback
#         # acl not_enough_servers nbsrv(bk_production_without_sticky) lt 1

#         unique-id-format  %{+X}o\ %pid%ci%cp%fi%fp%Ts%ms%rt
#         acl cid_exists req.hdr(X-Correlation-ID) -m found
#         http-request set-header X-Correlation-ID %[unique-id] unless cid_exists
#         http-request capture hdr(X-Correlation-ID) len 64
#         http-request capture req.hdr(Host) len 50
#         log-format {\"id\":\"%[capture.req.hdr(0),json(utf8)]\",\"httphost\":\"%[capture.req.hdr(1),json(utf8)]\",\"host\":\"%H\",\"HU\":\"%HU\",\"ST\":\"%ST\",\"T\":\"%T\",\"Ta\":%Ta,\"Tc\":%Tc,\"Td\":%Td,\"Th\":%Th,\"Ti\":%Ti,\"Tq\":%Tq,\"TR\":%TR,\"Tr\":%Tr,\"Tt\":%Tt,\"ac\":%ac,\"bc\":%bc,\"bq\":%bq,\"fc\":%fc,\"rc\":%rc,\"s\":\"%s\",\"sc\":%sc,\"sq\":%sq,\"t\":\"%t\",\"trg\":\"%trg\",\"ts\":\"%ts\"}

#         http-request set-log-level silent unless should_log

#         http-request set-header Host %[hdr(host),map(/etc/haproxy/customdomains.map)] if { hdr(host),map(/etc/haproxy/customdomains.map) -i -m found }


#         redirect prefix https://xxl.customer.eclub.se code 301 if { path_sub 5vl2Y4QYckWGJqoCAT8HgQ } { hdr_sub(host) -i xxlno }
#         redirect prefix https://xxl.customer.eclub.se code 301 if { path_sub ku2q6v6cY0y0OaoCAT8yJg } { hdr_sub(host) -i xxlno }
#         redirect prefix https://xxl.customer.eclub.se code 301 if { path_sub nii78pBWdE-M_aoCAT7T5A } { hdr_sub(host) -i xxlno }
#         redirect prefix https://xxl.customer.eclub.se code 301 if { path_sub zKaADhLF30O3mqoCAT7_9Q } { hdr_sub(host) -i xxlno }
#         redirect prefix https://xxl.customer.eclub.se code 301 if { path_sub piYo0RqUm0mj9qoCAT7_9g } { hdr_sub(host) -i xxlno }



#         # http-request redirect prefix https://%[req.hdr(Host),lower,field(1,:),regsub(^web\.,),regsub(\.eclub\.se$,.customer.eclub.se),regsub(\.voyado\.com$,.customer.voyado.com)] code 302 if is_old_public host_production
#         http-request redirect prefix https://%[req.hdr(Host),lower,field(1,:),regsub(euronics\.,elonnorge.)] code 302 if { hdr_sub(host) -i euronics.instore }
#         # http-request set-header Host %[req.hdr(Host),regsub(\.customer,)] if is_new_public host_production

#         redirect location https://kjell.com/medlem if host_kjell is_root
#         redirect location https://medlem.mio.se if host_medlmio is_root

#         #felstavad acceptanstest
#         #http-request redirect code 302 location https://%[hdr(host),regsub(acceptancetest,acceptanstest)] if { hdr_sub(host) -i acceptancetest }

#         #hotfix revide utskick
#         redirect location http://www.revide.se/sv/kontakt code 302 if { path_beg /link/BYt_JXVzNkyN5alRAOj9Wg }
#         redirect location http://www.revide.se/sv/kontakt code 302 if { path_beg /link/vvYWvgHpokCprqlRAOj9Wg }

#         http-request set-path /partners/%[path] if !has_partners_in_path2 !has_partners_in_path host_is_partners
#         http-request replace-value Host partners\.(.*) \1
#         http-request replace-value Host manage\-(.*) \1
#         http-request replace-value Host waynescoffee\.customer\.eclub\.se web.waynescoffee.eclub.se
#         http-request replace-value Host medlem\.dormy\.com dormy.voyado.com if host_dormy
#         http-request replace-value Host mekonomen\.customer\.eclub\.se mekonomen.eclub.se
#         http-request replace-value Host rusta\.customer\.eclub\.se rusta.eclub.se
#         http-request replace-value Host rustano\.customer\.eclub\.se rustano.eclub.se
#         http-request replace-value Host rustade\.customer\.eclub\.se rustade.eclub.se
#         http-request replace-value Host lagerhaus\.customer\.voyado\.com lagerhaus.voyado.com
#         #http-request replace-value Host socialcallback.voyado.com voyadofbauthorizationredirect.azurewebsites.net if host_is_socialcallback
#         #http-request set-header Host fbauthorizationredirect20181108020325.azurewebsites.net if host_is_socialcallback_test

#         http-request set-var(req.origpath) path
#         http-request set-query pageUrl=%[var(req.origpath),regsub(^/,)] if host_landingpagesmio !path_is_open
#         http-request set-path /open/landingpage/index if host_landingpagesmio !path_is_open
#         http-request set-header Host mio.eclub.se if host_landingpagesmio

#         http-request set-query pageUrl=%[var(req.origpath),regsub(^/,)] if host_landingpageshemglass !path_is_open
#         http-request set-path /open/landingpage/index if host_landingpageshemglass !path_is_open
#         http-request set-header Host hemglass.eclub.se if host_landingpageshemglass


#         # Check what backend to handle the request
#         # default_backend bk_production_without_sticky

#         # use_backend link_servers_prod if is_link_path is_az_link_enabled

#         # use_backend bk_production_without_sticky if host_dormy

#         use_backend letsencrypt-backend if letsencrypt-acl
#         use_backend be_429_slow_down_1s if api_request has_apikey exceeds_limit_1s
#         #use_backend be_429_slow_down_60s if api_request has_apikey exceeds_limit_60s
#         use_backend bk_csrdsv if path_is_googleverification
#         use_backend bk_csrdsv if path_is_loaderio_verification
#         use_backend bk_csrdsv if path_is_symantec_verification
#         use_backend bk_acceptanstest if host_acceptanstest
#         # use_backend bk_staging if host_staging

#         #use_backend bk_socialcallback if host_is_socialcallback
#         #use_backend bk_socialcallback_test if host_is_socialcallback_test
# #        use_backend bk_production_beta if host_production is_beta

#         # use_backend bk_production_api if host_production api_request
#         # use_backend bk_production_public if host_production path_is_linkclick

#         # use_backend bk_production_api if host_kjell api_request
#         # use_backend bk_production_public if host_kjell path_is_linkclick

#         #Fallback
#         # use_backend bk_production_backup if not_enough_servers
#         # use_backend bk_production if has_tenants_in_path


#         # use_backend bk_production_without_sticky if host_production
#         # use_backend bk_production_without_sticky if host_flinks_m
#         # use_backend bk_staging if host_kjell_s
#         # use_backend bk_staging if host_kjell_s_tiny
#         # use_backend bk_production_without_sticky if host_kjell
#         # use_backend bk_production_without_sticky if host_kjell_tiny



backend stats_back
    mode http
    option http-server-close
    balance roundrobin
    server HAProxy1 10.1.0.5:8990 check

backend bk_acceptanstest
    mode http
        option httpchk GET /Development/Installation/check
        http-check expect string OK
        default-server inter 10s fall 3 rise 2
    option http-server-close
    balance leastconn
    cookie SERVERID insert indirect
     server front1 20.105.3.22:8086 check cookie s1_acceptanstest
     server front2 20.105.3.22:33394 check cookie s2_acceptanstest

# backend bk_staging
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#         default-server inter 10s fall 3 rise 2
#     option http-server-close
#     balance leastconn
#     cookie SERVERID insert indirect
#     server eClubTest01 eclubtest.cloudapp.net:8084 check cookie s1_staging
#     server eClubTest02 eclubtest.cloudapp.net:8085 check cookie s2_staging

# backend bk_production
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#     option http-server-close
#     option allbackups
#     default-server inter 10s fall 3 rise 2
#     balance leastconn
#     cookie SERVERID insert indirect
#     server front1-vm-prod 10.1.2.4:8086 check cookie s4
#     server front2-vm-prod 10.1.2.5:8086 check cookie s5
#     server front3-vm-prod 10.1.2.6:8086 check cookie s6
#     server api4-vm-prod 10.1.4.7:8086 check cookie s7
#     server link2-vm-prod 10.1.5.5:8086 check cookie s8 backup
#     server mail3-vm-prod 10.1.6.6:8086 check cookie s9 backup

#  #   server link1-vm-prod 10.1.5.4:8086 check cookie link1 backup

# backend bk_production_without_sticky
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#     option http-server-close
#     option allbackups
#     default-server inter 10s fall 3 rise 2
#     balance leastconn
#     server front1-vm-prod 10.1.2.4:8086 check
#     server front2-vm-prod 10.1.2.5:8086 check
#     server front3-vm-prod 10.1.2.6:8086 check
#     server api4-vm-prod 10.1.4.7:8086 check
#     server link2-vm-prod 10.1.5.5:8086 check backup
#     server auto1-vm-prod 10.1.7.4:8086 check backup
#     server auto2-vm-prod 10.1.7.5:8086 check backup

#backend bk_production_beta
#    mode http
#        option httpchk GET /Development/Installation/check
#        http-check expect string OK
#    option http-server-close
#    option allbackups
#    default-server inter 10s fall 3 rise 2
#    balance leastconn
#    server front3-vm-prod 10.1.2.6:8086 check

 #   server mail3-vm-prod 10.1.6.6:8086 check backup


#    server link1-vm-prod 10.1.5.4:8086 check backup


# backend bk_production_public
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#     option http-server-close
#     option allbackups
#     default-server inter 10s fall 3 rise 2
#     balance leastconn
#     server link1-vm-prod 10.1.5.4:8086 check
#     server link2-vm-prod 10.1.5.5:8086 check

# #    server api1-vm-prod 10.1.4.4:8086 check backup
# #    server api2-vm-prod 10.1.4.5:8086 check backup
# #    server api3-vm-prod 10.1.4.6:8086 check backup
#     server front1-vm-prod 10.1.2.4:8086 check backup
#     server front2-vm-prod 10.1.2.5:8086 check backup
#     server front3-vm-prod 10.1.2.6:8086 check backup
# #    server mail3-vm-prod 10.1.6.6:8086 check backup

# backend bk_production_api
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#     option http-keep-alive
# #    option prefer-last-server
#     option allbackups
#     default-server inter 10s fall 3 rise 2
#     balance leastconn
#     server api1-vm-prod 10.1.4.4:8086 check maxconn 500
#     server api2-vm-prod 10.1.4.5:8086 check maxconn 500
#     server api3-vm-prod 10.1.4.6:8086 check maxconn 500
#     server api4-vm-prod 10.1.4.7:8086 check maxconn 500
#     #server api5-vm-prod 10.1.4.8:8086 check maxconn 500
#     server link1-vm-prod 10.1.5.4:8086 check backup maxconn 500
#     server link2-vm-prod 10.1.5.5:8086 check backup maxconn 500
#     server front1-vm-prod 10.1.2.4:8086 check backup maxconn 500
#     server front2-vm-prod 10.1.2.5:8086 check backup maxconn 500
#     server front3-vm-prod 10.1.2.6:8086 check backup maxconn 500

# backend bk_production_backup
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#     option http-server-close
#     default-server inter 240s fall 3 rise 2
#     balance leastconn
#     server front1-vm-prodS 10.1.2.4:8086 check
#     server front2-vm-prodS 10.1.2.5:8086 check
#     server front3-vm-prodS 10.1.2.6:8086 check

# backend bk_production_workers
#     mode http
#         option httpchk GET /Development/Installation/check
#         http-check expect string OK
#     default-server inter 60s fall 3 rise 2
#     balance leastconn
#     server auto1-vm-prod 10.1.7.4:8086 check
#     server auto2-vm-prod 10.1.7.5:8086 check
#     server bulk1-vm-prod 10.1.3.4:8086 check
#     server bulk2-vm-prod 10.1.3.5:8086 check
#     server mail1-vm-prod 10.1.6.4:8086 check
#     server mail2-vm-prod 10.1.6.5:8086 check
#     server mail3-vm-prod 10.1.6.6:8086 check

#backend bk_production_beta
#    mode http
#       option httpchk GET /Development/Installation/check
#       http-check expect string OK
#    default-server inter 10s fall 3 rise 2
#    balance leastconn
#    cookie SERVERID insert indirect
#    server eClubDrift1 eclub.cloudapp.net:9086 check cookie s1
#    server eClubDrift2 eclub.cloudapp.net:9087 check cookie s2
#    server eClubDrift3 eclub.cloudapp.net:9088 check cookie s3

backend bk_csrdsv
    mode http
    http-request set-header Host httpcsrdsv.azurewebsites.net
    server csr httpcsrdsv.azurewebsites.net:443 ssl verify none

backend bk_429
    http-request deny deny_status 429

backend bk_429_slow_down
  timeout tarpit 2s
  http-request deny deny_status 429
#errorfile 500 /etc/haproxy/errors/429.http
  http-request tarpit

backend letsencrypt-backend
   server letsencrypt 127.0.0.1:54321

backend link_servers_atst
        mode http
        http-request set-path /api/%[req.hdr(host),lower,map(/etc/haproxy/use-az-fn-link-jump.atst.map)]%[path,regsub(^/link/|^/open/link/jump/,/)]
        http-request set-header Host emaillinkjump-azfun-atst.azurewebsites.net
        server link_jump emaillinkjump-azfun-atst.azurewebsites.net:80

# backend link_servers_stag
#         mode http
#         http-request set-path /api/%[req.hdr(host),lower,map(/etc/haproxy/use-az-fn-link-jump.stag.map)]%[path,regsub(^/link/|^/open/link/jump/,/)]
#         http-request set-header Host emaillinkjump-azfun-stag.azurewebsites.net
#         server link_jump emaillinkjump-azfun-stag.azurewebsites.net:80

# backend link_servers_prod
#         mode http
#         http-request set-path /api/%[req.hdr(host),lower,map(/etc/haproxy/use-az-fn-link-jump.prod.map)]%[path,regsub(^/link/|^/open/link/jump/,/)]
#         http-request set-header Host emaillinkjump-azfun-prod.azurewebsites.net
#         server link_jump emaillinkjump-azfun-prod.azurewebsites.net:80

backend be_table_ratelimit_1s
        stick-table type string len 180 size 200k expire 24h store http_req_rate(1s)

backend be_table_ratelimit_60s
        stick-table type string len 180 size 200k expire 24h store http_req_rate(60s)

backend be_429_slow_down_1s
    mode http
    timeout tarpit 5s
    errorfile 429 /etc/haproxy/errors/429_1s.http
    http-request tarpit deny_status 429

backend be_429_slow_down_60s
    mode http
    timeout tarpit 5s
    errorfile 429 /etc/haproxy/errors/429_60s.http
    http-request tarpit deny_status 429
